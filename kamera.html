<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Baret Tespiti</title>
  <style>
    body { text-align: center; font-family: sans-serif;padding:0;margin:0;overflow:hidden }
    video, canvas { position:absolute;left:5%;width: 90%; max-width: 400px;max-height:95vh; border: 1px solid #ccc; margin-top: 10px; }
    video {visibility:hidden}
    #uyari { font-size: 20px; color: red; font-weight: bold;position:absolute;bottom:10px;margin:auto;}
  </style>
</head>
<body>
<h2>Baret Kontrol <font color="blue" size="3">by Samet Akyel</font></h2>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
<div id="uyari"></div>
  <!-- TensorFlow ve model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const uyari = document.getElementById('uyari');
    let model;

    async function baslat() {
      model = await blazeface.load();
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        tespitEt();
      };
    }

    function ortalamaRGB(data) {
      let r = 0, g = 0, b = 0;
      let count = data.length / 4;
      for (let i = 0; i < data.length; i += 4) {
        r += data[i]; g += data[i + 1]; b += data[i + 2];
      }
      return [r / count, g / count, b / count];
    }

    function renkFarki(rgb1, rgb2) {
      return Math.sqrt(
        (rgb1[0] - rgb2[0]) ** 2 +
        (rgb1[1] - rgb2[1]) ** 2 +
        (rgb1[2] - rgb2[2]) ** 2
      );
    }

    async function tespitEt() {
      while (true) {
        const predictions = await model.estimateFaces(video, false);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let baretVar = false;

        predictions.forEach(pred => {
          const [x1, y1] = pred.topLeft;
          const [x2, y2] = pred.bottomRight;

          const yüzW = x2 - x1;
          const yüzH = y2 - y1;

          // Yüz bölgesi
          const yüzX = x1 + yüzW * 0.2;
          const yüzY = y1 + yüzH * 0.4;
          const yüzW2 = yüzW * 0.6;
          const yüzH2 = yüzH * 0.5;
          const yüzData = ctx.getImageData(yüzX, yüzY, yüzW2, yüzH2).data;
          const ciltRenk = ortalamaRGB(yüzData);

          // Baret kontrol bölgesi (kafa üstü)
          const roiX = x1 - yüzW * 0.2;
          const roiY = y1 - yüzH * 0.6;
          const roiW = yüzW * 1.4;
          const roiH = yüzH * 0.5;

          const safeX = Math.max(0, roiX);
          const safeY = Math.max(0, roiY);
          const safeW = Math.min(canvas.width - safeX, roiW);
          const safeH = Math.min(canvas.height - safeY, roiH);

          const data = ctx.getImageData(safeX, safeY, safeW, safeH).data;

          let farklıPixel = 0;
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const fark = renkFarki([r,g,b], ciltRenk);
            if (fark > 80) farklıPixel++;
          }

          const oran = farklıPixel / (safeW * safeH);
          if (oran > 0.25) baretVar = true;

          ctx.strokeStyle = baretVar ? "green" : "red";
          ctx.lineWidth = 3;
          ctx.strokeRect(safeX, safeY, safeW, safeH);
          ctx.font = "16px sans-serif";
          ctx.fillStyle = baretVar ? "green" : "red";
          ctx.fillText(baretVar ? "Baret Var" : "Baret Yok", safeX, safeY - 8);
        });

        uyari.textContent = baretVar ? "" : "❌ Baret tespit edilemedi!";
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }

    baslat();
</script>
</body>
</html>
