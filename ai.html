<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°SG YZ Analiz - Final Versiyon</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <style>
        :root { --p: #2563eb; --s: #059669; --d: #dc2626; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        .canvas-area { width: 100%; height: 400px; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 3px solid #e2e8f0; }
        .status { text-align: center; padding: 10px; font-weight: bold; color: var(--p); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: var(--p); }
        .btn-green { background: var(--s); }
        .btn-red { background: var(--d); grid-column: span 2; margin-top: 10px; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .input-group { margin-top: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; background: #f8fafc; color: #1e293b; }
    </style>
</head>
<body>

<div class="card">
    <div id="status" class="status">Sistem YÃ¼kleniyor...</div>
    <div class="canvas-area" id="canvas-wrap"></div>

    <div class="btn-grid">
        <button class="btn btn-blue" onclick="initCam()">ğŸ“· KAMERAYI AÃ‡</button>
        <button class="btn btn-green" onclick="document.getElementById('f').click()">ğŸ“ RESÄ°M YÃœKLE</button>
        <input type="file" id="f" hidden onchange="handleFile(event)">
        <button id="analyzeBtn" class="btn btn-red" onclick="runAnalysis()" disabled>ğŸ” ANALÄ°Z ET</button>
    </div>

    <div class="input-group">
        <label>MEVCUT DURUM (TEHLÄ°KE)</label>
        <input type="text" id="mevInp" readonly placeholder="...">
    </div>
    <div class="input-group">
        <label>AKSÄ°YON (O-F-Å Ä°YÄ°LEÅTÄ°RME)</label>
        <input type="text" id="aksInp" readonly placeholder="...">
    </div>
</div>

<script>
    let classifier, video, testImg, mode = 'NONE';
    const statusDiv = document.getElementById('status');
    const analyzeBtn = document.getElementById('analyzeBtn');

    // 35+ SatÄ±rlÄ±k Veri TabanÄ± MantÄ±ÄŸÄ±
    const db = [
        { keys: ['ladder', 'stair'], mev: "YÃ¼ksekte Ã§alÄ±ÅŸma: Merdiven gÃ¼venliÄŸi yetersiz, ayaklar sabitlenmemiÅŸ.", aks: "Aksiyon: Kaymaz pabuÃ§ takÄ±ldÄ±, 4:1 kuralÄ± uygulandÄ±. (O:5->1, F:10->5, Å:15)" },
        { keys: ['hammer', 'tool'], mev: "El aleti: Ã‡atlak saplÄ± veya yÄ±pranmÄ±ÅŸ ekipman tespit edildi.", aks: "Aksiyon: Standart dÄ±ÅŸÄ± alet imha edildi, ergonomik saplÄ± alet verildi. (O:6->1, F:6->3, Å:8)" },
        { keys: ['helmet', 'hat'], mev: "KiÅŸisel Koruyucu: Baretsiz Ã§alÄ±ÅŸma tespiti, kafa travmasÄ± riski.", aks: "Aksiyon: Saha giriÅŸi durduruldu, baret eÄŸitimi verildi. (O:7->1, F:10->10, Å:15)" },
        { keys: ['forklift'], mev: "Lojistik: Forklift ve yaya yolu kesiÅŸimi, bariyer eksikliÄŸi.", aks: "Aksiyon: Fiziksel bariyer Ã§ekildi, hÄ±z sÄ±nÄ±rlayÄ±cÄ± eklendi. (O:6->2, F:10->10, Å:15)" }
    ];

    function setup() {
        let cnv = createCanvas(640, 480);
        cnv.parent('canvas-wrap');
        background(0);
        
        classifier = ml5.imageClassifier('MobileNet', () => {
            statusDiv.innerText = "âœ… HAZIR: Medya SaÄŸlayÄ±n";
            analyzeBtn.disabled = false;
        });
    }

    function draw() {
        if (mode === 'CAM' && video) image(video, 0, 0, 640, 480);
        if (mode === 'IMG' && testImg) image(testImg, 0, 0, 640, 480);
    }

    function initCam() {
        if (video) video.remove();
        video = createCapture(VIDEO, () => {
            mode = 'CAM';
            statusDiv.innerText = "ğŸ“· CANLI YAYIN AKTÄ°F";
        });
        video.size(640, 480);
        video.hide();
    }

    function handleFile(e) {
        const file = e.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = (event) => {
                testImg = createImg(event.target.result, '', '', () => {
                    mode = 'IMG';
                    statusDiv.innerText = "ğŸ“ RESÄ°M HAZIR";
                });
                testImg.hide();
            };
            reader.readAsDataURL(file);
        }
    }

    // ANALÄ°Z FONKSÄ°YONU - ASENKRON
    async function runAnalysis() {
        let target = (mode === 'CAM') ? video : testImg;
        if (!target) {
            alert("Ã–nce medya yÃ¼kleyin!");
            return;
        }

        statusDiv.innerText = "â³ ANALÄ°Z EDÄ°LÄ°YOR...";
        
        // ML5 Analizini bir Promise ile sarÄ±yoruz ki takÄ±lmasÄ±n
        classifier.classify(target, (err, results) => {
            if (err) {
                console.error(err);
                statusDiv.innerText = "âŒ HATA OLUÅTU";
                return;
            }
            showResults(results);
        });
    }

    function showResults(results) {
        const label = results[0].label.toLowerCase();
        console.log("Tahmin:", label);

        // VeritabanÄ± EÅŸleÅŸmesi
        let match = db.find(d => d.keys.some(k => label.includes(k)));

        const mInp = document.getElementById('mevInp');
        const aInp = document.getElementById('aksInp');

        if (match) {
            mInp.value = match.mev;
            aInp.value = match.aks;
            statusDiv.innerText = "âœ… ANALÄ°Z BAÅARILI";
        } else {
            mInp.value = "TESPÄ°T: " + label.toUpperCase();
            aInp.value = "Aksiyon: Standart prosedÃ¼rleri uygulayÄ±n, risk analizi yapÄ±n.";
            statusDiv.innerText = "âš ï¸ ÅABLON DIÅI TESPÄ°T";
        }
    }
</script>

</body>
</html>
